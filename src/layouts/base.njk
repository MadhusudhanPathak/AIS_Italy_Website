<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{{ site.site.description }}">
    <meta name="author" content="{{ site.site.name }}">
    <meta name="theme-color" content="{{ design.colors.brand.primary | default('#3b82f6') }}">
    <title>{% if title %}{{ title }} | {% endif %}{{ site.site.name }}</title>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="icon" type="image/svg+xml" href="/assets/img/favicon.svg">
</head>
<body class="bg-white text-primary-900 dark:bg-primary-900 dark:text-primary-100">
    {% include "header.njk" %}

    <main id="main" class="min-h-screen">
        {{ content | safe }}
    </main>

    {% include "footer.njk" %}

    <script>
        // DOM ready function
        function domReady(callback) {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', callback);
            } else {
                callback();
            }
        }

        // Toggle mobile menu with error handling
        function toggleMenu() {
            try {
                const menu = document.getElementById('mobileMenu');
                const btn = document.getElementById('menuToggle');
                
                if (!menu || !btn) {
                    console.error('Mobile menu elements not found');
                    return;
                }
                
                const isHidden = menu.classList.contains('hidden');
                if (isHidden) {
                    menu.classList.remove('hidden');
                    btn.setAttribute('aria-expanded', 'true');
                    // Focus first element in menu for accessibility
                    const firstFocusable = menu.querySelector('a, button, input');
                    if (firstFocusable) {
                        firstFocusable.focus();
                    }
                } else {
                    menu.classList.add('hidden');
                    btn.setAttribute('aria-expanded', 'false');
                    btn.focus(); // Return focus to menu button
                }
            } catch (error) {
                console.error('Error toggling menu:', error);
            }
        }

        // Close mobile menu when clicking outside
        function setupOutsideClickHandler() {
            try {
                document.addEventListener('click', function (e) {
                    const menu = document.getElementById('mobileMenu');
                    const btn = document.getElementById('menuToggle');
                    
                    if (!menu || !btn) return;
                    
                    if (!menu.classList.contains('hidden')) {
                        if (!menu.contains(e.target) && !btn.contains(e.target)) {
                            menu.classList.add('hidden');
                            btn.setAttribute('aria-expanded', 'false');
                        }
                    }
                });
            } catch (error) {
                console.error('Error setting up outside click handler:', error);
            }
        }

        // Initialize when DOM is ready
        domReady(function() {
            setupOutsideClickHandler();
            
            // Add error handling for potential JavaScript issues
            window.addEventListener('error', function(e) {
                console.error('JavaScript error:', e.error);
            });
        });

        // Enhanced keyboard navigation
        document.addEventListener('keydown', function(e) {
            // Close menu with Escape key
            if (e.key === 'Escape') {
                const menu = document.getElementById('mobileMenu');
                const btn = document.getElementById('menuToggle');

                if (menu && !menu.classList.contains('hidden')) {
                    menu.classList.add('hidden');
                    btn.setAttribute('aria-expanded', 'false');
                    btn.focus();
                }
            }
        });

        // Theme toggle functionality
        function initThemeToggle() {
            const themeToggleBtn = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const currentTheme = localStorage.getItem('theme') || '{{ design.themes.light.isDefault == true and "light" or "dark" }}';

            // Apply saved theme on page load
            if (currentTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '{{ design.themes.toggle.icon.light | default("‚òÄÔ∏è") }}'; // Sun icon for light mode
            } else {
                document.documentElement.removeAttribute('data-theme');
                themeIcon.textContent = '{{ design.themes.toggle.icon.dark | default("üåô") }}'; // Moon icon for dark mode
            }

            // Update background images based on theme
            function updateBackgroundImages() {
                const heroBgs = document.querySelectorAll('.hero-background');
                heroBgs.forEach(heroBg => {
                    if (document.documentElement.getAttribute('data-theme') === 'dark') {
                        heroBg.style.backgroundImage = 'url("/assets/img/ais_italy_dark_bg.png")';
                    } else {
                        heroBg.style.backgroundImage = 'url("/assets/img/ais_italy_light_bg.png")';
                    }
                });
                
                // Also update any other themed backgrounds if needed
                const themedElements = document.querySelectorAll('[data-theme-bg]');
                themedElements.forEach(element => {
                    const lightBg = element.getAttribute('data-theme-bg-light');
                    const darkBg = element.getAttribute('data-theme-bg-dark');
                    
                    if (document.documentElement.getAttribute('data-theme') === 'dark') {
                        if (darkBg) element.style.backgroundImage = `url("${darkBg}")`;
                    } else {
                        if (lightBg) element.style.backgroundImage = `url("${lightBg}")`;
                    }
                });
            }

            // Initialize background images
            updateBackgroundImages();

            // Add click event to toggle theme
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', function() {
                    const currentThemeAttr = document.documentElement.getAttribute('data-theme');

                    if (currentThemeAttr === 'dark') {
                        // Switch to light mode
                        document.documentElement.removeAttribute('data-theme');
                        localStorage.setItem('theme', 'light');
                        themeIcon.textContent = 'üåô';
                    } else {
                        // Switch to dark mode
                        document.documentElement.setAttribute('data-theme', 'dark');
                        localStorage.setItem('theme', 'dark');
                        themeIcon.textContent = '‚òÄÔ∏è';
                    }

                    // Update background images after theme change
                    updateBackgroundImages();
                });
            }
        }

        // Initialize theme toggle when DOM is ready
        domReady(initThemeToggle);
    </script>
</body>
</html>
